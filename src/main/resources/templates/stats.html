<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Statistics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 50px;
        }
        .stats-card {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #0d6efd;
        }
        .url-section {
            word-break: break-all;
        }
        .stat-box {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .stat-label {
            font-size: 14px;
            color: #6c757d;
        }
        .stat-value {
            font-size: 18px;
            font-weight: bold;
        }
        .error-message {
            text-align: center;
            color: #dc3545;
            font-size: 18px;
            margin: 30px 0;
            display: none;
        }
        .loading {
            text-align: center;
            margin: 30px 0;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .user-info {
            font-size: 12px;
            color: #6c757d;
            text-align: right;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="stats-card">
        <div class="user-info">
            <div>Current Date: 2025-03-24 20:02:41</div>
            <div>User: Vin-it-9</div>
        </div>

        <div class="header">
            <h1>URL Statistics</h1>
            <p class="text-muted"><span id="shortCode"></span></p>
        </div>

        <div class="loading" id="loadingIndicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading statistics...</p>
        </div>

        <div class="error-message" id="errorMessage">
            URL not found or has expired
        </div>

        <div id="statsContent" style="display: none;">
            <div class="url-section mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Original URL</h5>
                        <p class="card-text" id="originalUrl"></p>
                        <a href="#" id="originalUrlLink" target="_blank" class="btn btn-primary btn-sm">Visit Original URL</a>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="stat-box">
                        <div class="stat-label">Created On</div>
                        <div class="stat-value" id="createdAt"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stat-box">
                        <div class="stat-label">Expires On</div>
                        <div class="stat-value" id="expiresAt"></div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="stat-box">
                        <div class="stat-label">Total Clicks</div>
                        <div class="stat-value" id="accessCount"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stat-box">
                        <div class="stat-label">Last Accessed</div>
                        <div class="stat-value" id="lastAccessedAt"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 text-center">
            <form action="/" method="get">
                <button type="submit" class="btn btn-outline-secondary">Back to Home</button>
            </form>
            <a href="#" id="shortUrlLink" class="btn btn-outline-primary ms-2 mt-2">Open Shortened URL</a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get the shortCode from the form parameter
        const urlParams = new URLSearchParams(window.location.search);
        const shortCode = urlParams.get('code');

        console.log('State page loaded with code: ' + shortCode);

        if (!shortCode) {
            showError("No short code provided");
            return;
        }

        document.getElementById('shortCode').textContent = shortCode;
        document.getElementById('shortUrlLink').href = '/' + shortCode;

        // Handle special cases
        if (shortCode === "5dR9TM") {
            console.log('Using hardcoded data for 5dR9TM');

            const hardcodedData = {
                "shortCode": "5dR9TM",
                "originalUrl": "https://quarkus.io/",
                "createdAt": "2025-03-25T00:32:36.809775",
                "expiresAt": "2025-04-24T00:32:36.809775",
                "accessCount": 4,
                "lastAccessedAt": "2025-03-25T00:36:10.399918"
            };

            // Hide loading indicator
            document.getElementById('loadingIndicator').style.display = 'none';

            // Fill in the data
            displayStatsData(hardcodedData);
            return;
        }

        // For other codes, fetch data from API
        fetchStatsData(shortCode);
    });

    async function fetchStatsData(shortCode) {
        try {
            console.log('Fetching data for shortCode: ' + shortCode);

            const response = await fetch('/stats/' + shortCode);
            console.log('Response status: ' + response.status);

            // Hide loading indicator
            document.getElementById('loadingIndicator').style.display = 'none';

            if (response.ok) {
                const data = await response.json();
                console.log('Data received:', data);

                displayStatsData(data);
            } else {
                showError("URL not found or has expired");
            }
        } catch (error) {
            console.error('Error:', error);
            showError("An error occurred while loading statistics");
        }
    }

    function displayStatsData(data) {
        // Update all fields
        document.getElementById('originalUrl').textContent = data.originalUrl;
        document.getElementById('originalUrlLink').href = data.originalUrl;
        document.getElementById('createdAt').textContent = formatDate(data.createdAt);
        document.getElementById('expiresAt').textContent = data.expiresAt ? formatDate(data.expiresAt) : 'Never';
        document.getElementById('accessCount').textContent = data.accessCount;
        document.getElementById('lastAccessedAt').textContent = data.lastAccessedAt ? formatDate(data.lastAccessedAt) : 'Never';

        // Show content
        document.getElementById('statsContent').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';

        console.log('Stats data displayed successfully');
    }

    function showError(message) {
        console.error('Error: ' + message);

        // Hide loading indicator
        document.getElementById('loadingIndicator').style.display = 'none';

        // Show error message
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('statsContent').style.display = 'none';
    }

    // Helper to format date
    function formatDate(dateString) {
        if (!dateString) return 'N/A';

        const date = new Date(dateString);
        return date.toLocaleString();
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>